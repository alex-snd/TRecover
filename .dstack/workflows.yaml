workflows:
  - name: train
    help: 'Starts collaborative training'
    provider: bash
    python: 3.8
    ports: 1
    commands:
      - apt update && apt upgrade -y && apt install curl git -y
      - curl -s ipinfo.io > ipinfo.json
      - export ANNOUNCE_IP=`python3 -c "import json; ipinfo = json.load(open('ipinfo.json')); print(ipinfo['ip'])"`
      - git clone -b big https://github.com/alex-snd/TRecover.git
      - pip install "TRecover/.[collab]"
      - trecover init
      - trecover download data
      - trecover collab train --initial-peers /ip4/95.216.202.215/tcp/34234/p2p/QmS2mYPX8Q78RDQzxMf17phVYPashi4C6ixVbA3jrj9yxt --experiment-prefix big --host-maddrs /ip4/0.0.0.0/tcp/$PORT_0 --announce-maddrs /ip4/$ANNOUNCE_IP/tcp/$PORT_0 --batch-size 4 --bandwidth 500 --backup-every-step 1
    artifacts:
      - path: experiments
    resources:
      shm_size: '16GB'
      gpu:
        memory: '16GB'
        count: 1